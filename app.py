import streamlit as st
import pandas as pd
from auth import login
from sheets import open_sheet

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ë³¸ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="í•˜ëŠ˜ê¿ˆì—°ë™êµíšŒ ë¶€ë¶€ì²­ë…„ë¶€ íšŒê³„ê´€ë¦¬",
    layout="wide"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë¡œê·¸ì¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if not login():
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ì´ë“œë°”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.sidebar.success(f"ğŸ‘¤ {st.session_state.user_id} ë¡œê·¸ì¸ ì¤‘")

menu = st.sidebar.radio(
    "ë©”ë‰´",
    ["ëŒ€ì‹œë³´ë“œ", "íšŒê³„ ì…ë ¥", "íšŒê³„ í˜„í™©", "CSV ë‹¤ìš´ë¡œë“œ"]
)

if st.sidebar.button("ë¡œê·¸ì•„ì›ƒ"):
    st.session_state.clear()
    st.rerun()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Google Sheet ì—°ê²°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    sheet = open_sheet("í•˜ëŠ˜ê¿ˆì—°ë™êµíšŒ ë¶€ë¶€ì²­ë…„ë¶€ íšŒê³„ê´€ë¦¬")
    ws = sheet.worksheet("ì›ì¥")
except Exception as e:
    st.error("êµ¬ê¸€ì‹œíŠ¸ ì—°ê²° ì‹¤íŒ¨")
    st.stop()

# ë°ì´í„° ë¡œë“œ
records = ws.get_all_records()
df = pd.DataFrame(records)

# ë¹ˆ ì‹œíŠ¸ ë°©ì–´
if df.empty:
    df = pd.DataFrame(
        columns=["ê¸°ë¡ì¼ì", "íšŒê³„ì¼ì", "ì…ê¸ˆ", "ì…ê¸ˆë‚´ì—­", "ì¶œê¸ˆ", "ì¶œê¸ˆë‚´ì—­", "ì‘ì„±ì"]
    )

# ìˆ«ìí˜• ë³´ì •
for col in ["ì…ê¸ˆ", "ì¶œê¸ˆ"]:
    if col in df.columns:
        df[col] = pd.to_numeric(df[col], errors="coerce").fillna(0)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ëŒ€ì‹œë³´ë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if menu == "ëŒ€ì‹œë³´ë“œ":
    st.header("ğŸ“Š íšŒê³„ ìš”ì•½")

    total_in = df["ì…ê¸ˆ"].sum()
    total_out = df["ì¶œê¸ˆ"].sum()
    balance = total_in - total_out

    c1, c2, c3 = st.columns(3)
    c1.metric("ì´ ì…ê¸ˆ", f"{total_in:,.0f}ì›")
    c2.metric("ì´ ì¶œê¸ˆ", f"{total_out:,.0f}ì›")
    c3.metric("í˜„ì¬ ì”ì•¡", f"{balance:,.0f}ì›")

    st.divider()
    st.subheader("ìµœê·¼ ë‚´ì—­")
    st.dataframe(df.tail(10), use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íšŒê³„ ì…ë ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if menu == "íšŒê³„ ì…ë ¥":
    st.header("âœï¸ íšŒê³„ ì…ë ¥")

    with st.form("account_form"):
        col1, col2 = st.columns(2)

        with col1:
            accounting_date = st.date_input("íšŒê³„ì¼ì")
            income = st.number_input("ì…ê¸ˆ", min_value=0, step=1000)
            income_desc = st.text_input("ì…ê¸ˆ ë‚´ì—­")

        with col2:
            expense = st.number_input("ì¶œê¸ˆ", min_value=0, step=1000)
            expense_desc = st.text_input("ì¶œê¸ˆ ë‚´ì—­")

        submitted = st.form_submit_button("ì €ì¥")

        if submitted:
            ws.append_row([
                pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S"),
                str(accounting_date),
                income,
                income_desc,
                expense,
                expense_desc,
                st.session_state.user_id
            ])
            st.success("ì €ì¥ ì™„ë£Œ")
            st.rerun()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íšŒê³„ í˜„í™©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if menu == "íšŒê³„ í˜„í™©":
    st.header("ğŸ“‹ íšŒê³„ ì›ì¥")
    st.dataframe(df, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CSV ë‹¤ìš´ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if menu == "CSV ë‹¤ìš´ë¡œë“œ":
    st.header("â¬‡ CSV ë‹¤ìš´ë¡œë“œ")

    csv = df.to_csv(index=False).encode("utf-8-sig")
    st.download_button(
        label="íšŒê³„ ë‚´ì—­ CSV ë‹¤ìš´ë¡œë“œ",
        data=csv,
        file_name="í•˜ëŠ˜ê¿ˆì—°ë™êµíšŒ_ë¶€ë¶€ì²­ë…„ë¶€_íšŒê³„ë‚´ì—­.csv",
        mime="text/csv"
    )
